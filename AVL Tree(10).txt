#include <iostream>
#include <string>
using namespace std;

struct Contact {
    int id;
    string name, phone, email;
};

struct Node {
    Contact data;
    Node *left, *right;
    int height;
};

int getHeight(Node* n) {
    return (n == NULL) ? 0 : n->height;
}

int getBalance(Node* n) {
    return (n == NULL) ? 0 : getHeight(n->left) - getHeight(n->right);
}

Node* newNode(Contact c) {
    Node* node = new Node();
    node->data = c;
    node->left = node->right = NULL;
    node->height = 1;
    return node;
}

Node* rightRotate(Node* y) {
    Node* x = y->left;
    Node* T = x->right;

    x->right = y;
    y->left = T;

    y->height = max(getHeight(y->left), getHeight(y->right)) + 1;
    x->height = max(getHeight(x->left), getHeight(x->right)) + 1;

    return x;
}

Node* leftRotate(Node* x) {
    Node* y = x->right;
    Node* T = y->left;

    y->left = x;
    x->right = T;

    x->height = max(getHeight(x->left), getHeight(x->right)) + 1;
    y->height = max(getHeight(y->left), getHeight(y->right)) + 1;

    return y;
}

Node* insert(Node* root, Contact c) {
    if (root == NULL) return newNode(c);

    if (c.name < root->data.name)
        root->left = insert(root->left, c);
    else if (c.name > root->data.name)
        root->right = insert(root->right, c);
    else {
        cout << "\nDuplicate contact names not allowed!\n";
        return root;
    }

    root->height = 1 + max(getHeight(root->left), getHeight(root->right));
    int balance = getBalance(root);

    // Left Left
    if (balance > 1 && c.name < root->left->data.name)
        return rightRotate(root);

    // Right Right
    if (balance < -1 && c.name > root->right->data.name)
        return leftRotate(root);

    // Left Right
    if (balance > 1 && c.name > root->left->data.name) {
        root->left = leftRotate(root->left);
        return rightRotate(root);
    }

    // Right Left
    if (balance < -1 && c.name < root->right->data.name) {
        root->right = rightRotate(root->right);
        return leftRotate(root);
    }

    return root;
}

void inorder(Node* root) {
    if (root != NULL) {
        inorder(root->left);
        cout << root->data.id << " | " << root->data.name << " | " 
             << root->data.phone << " | " << root->data.email << endl;
        inorder(root->right);
    }
}

Node* search(Node* root, string key) {
    if (root == NULL || root->data.name == key) return root;

    if (key < root->data.name)
        return search(root->left, key);
    return search(root->right, key);
}

void updateContact(Node* root, string name) {
    Node* temp = search(root, name);
    if (temp == NULL) {
        cout << "\nContact not found!\n";
        return;
    }

    cout << "\nContact Found! Enter new details:\n";
    cout << "New Phone: ";
    cin >> temp->data.phone;
    cout << "New Email: ";
    cin >> temp->data.email;
    cout << "\nContact Updated Successfully!\n";
}

int main() {
    Node* root = NULL;
    
    // Initial Contacts
    root = insert(root, {101, "Rahul Sharma", "9876543210", "rahul@example.com"});
    root = insert(root, {102, "Priya Patel", "1234567890", "priya@example.com"});
    root = insert(root, {103, "Aarav Gupta", "8765432109", "aarav@example.com"});

    int choice;
    do {
        cout << "\n--- AVL Contact Management Menu ---\n";
        cout << "1. Add New Contact\n";
        cout << "2. Search Contact by Name\n";
        cout << "3. Update Contact\n";
        cout << "4. Display All Contacts (Sorted)\n";
        cout << "5. Exit\n";
        cout << "Enter choice: ";
        cin >> choice;

        if (choice == 1) {
            Contact c;
            cout << "\nEnter Contact ID: ";
            cin >> c.id;
            cin.ignore();
            cout << "Enter Name: ";
            getline(cin, c.name);
            cout << "Enter Phone: ";
            cin >> c.phone;
            cout << "Enter Email: ";
            cin >> c.email;
            root = insert(root, c);
            cout << "\nContact Added Successfully!\n";
        }

        else if (choice == 2) {
            string name;
            cout << "\nEnter Name to Search: ";
            cin.ignore();
            getline(cin, name);
            Node* res = search(root, name);
            if (res != NULL)
                cout << "\nContact Found: " << res->data.id << " | " << res->data.name 
                     << " | " << res->data.phone << " | " << res->data.email << endl;
            else
                cout << "\nContact Not Found!\n";
        }

        else if (choice == 3) {
            string name;
            cout << "\nEnter Name to Update: ";
            cin.ignore();
            getline(cin, name);
            updateContact(root, name);
        }

        else if (choice == 4) {
            cout << "\n--- Contact List (Sorted Alphabetically) ---\n";
            inorder(root);
        }

    } while (choice != 5);

    cout << "\nExiting Program...\n";
    return 0;
}
